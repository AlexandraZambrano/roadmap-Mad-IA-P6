const API_URL = window.APP_CONFIG?.API_URL || window.location.origin;
let promotionId = null;
let passwordModal = null;
let promotionHasPassword = false;
let isAccessVerified = false;
let isPreviewMode = false;

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    const params = new URLSearchParams(window.location.search);
    promotionId = params.get('id');
    isPreviewMode = params.get('preview') === '1';

    if (!promotionId) {
        document.body.innerHTML = '<div class="alert alert-danger m-5">Promotion not found</div>';
        return;
    }

    // Initialize password modal (student access mode only)
    const modalEl = document.getElementById('passwordModal');
    if (modalEl) {
        passwordModal = new bootstrap.Modal(modalEl, { backdrop: 'static', keyboard: false });
    }

    if (isPreviewMode) {
        // In preview mode (from teacher overview), bypass password and tracking
        loadPromotionContent();
    } else {
        // Check if promotion requires password
        checkPasswordRequirement();
    }
});

//visibility password
function togglePasswordVisibility() {
    const input = document.getElementById('access-password');
    const icon = document.getElementById('togglePasswordIcon');

    if (input.type === 'password') {
        input.type = 'text';
        icon.classList.replace('bi-eye', 'bi-eye-slash');
    } else {
        input.type = 'password';
        icon.classList.replace('bi-eye-slash', 'bi-eye');
    }
}

async function checkPasswordRequirement() {
    try {
        const response = await fetch(`${API_URL}/api/promotions/${promotionId}`);

        if (response.ok) {
            const promotion = await response.json();
            promotionHasPassword = !!promotion.accessPassword;

            if (promotionHasPassword && !isAccessVerified) {
                // Show password modal
                if (passwordModal) {
                    passwordModal.show();
                }
            } else {
                // Load promotion content
                loadPromotionContent();
            }
        }
    } catch (error) {
        console.error('Error checking password requirement:', error);
    }
}

// Verify promotion password
window.verifyPromotionPassword = async function () {
    const password = document.getElementById('access-password').value;
    const alertEl = document.getElementById('password-alert');
    const btnSpinner = document.querySelector('.modal-footer .spinner-border');

    if (!password) {
        alertEl.textContent = 'Please enter the password';
        alertEl.classList.remove('hidden');
        return;
    }

    alertEl.classList.add('hidden');
    btnSpinner.classList.remove('hidden');

    try {
        const response = await fetch(`${API_URL}/api/promotions/${promotionId}/verify-password`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ password })
        });

        const contentType = response.headers.get('content-type');
        let data;
        try {
            data = contentType && contentType.includes('application/json')
                ? await response.json()
                : {};
        } catch (parseError) {
            console.error('Error parsing response:', parseError);
            alertEl.textContent = 'Invalid server response. Please try again.';
            alertEl.classList.remove('hidden');
            btnSpinner.classList.add('hidden');
            return;
        }

        if (response.ok) {
            // Store access token in session storage (not localStorage) for security
            sessionStorage.setItem('promotionAccessToken', data.accessToken);
            sessionStorage.setItem('promotionId', promotionId);

            isAccessVerified = true;

            // Hide modal and load content
            if (passwordModal) {
                passwordModal.hide();
            }

            // Load content after successful password verification
            loadPromotionContent();
        } else {
            const errorMsg = data.error || 'Invalid password. Please try again.';
            alertEl.textContent = errorMsg;
            alertEl.classList.remove('hidden');
            console.error('Password verification failed:', response.status, data);
        }
    } catch (error) {
        console.error('Password verification error:', error);
        alertEl.textContent = 'Connection error. Please try again.';
        alertEl.classList.remove('hidden');
    } finally {
        btnSpinner.classList.add('hidden');
    }
};

async function loadPromotionContent() {
    await loadPromotion();
    // await loadModules(); // loadPromotion already calls generateGanttChart
    await loadQuickLinks();
    await loadSections();
    await loadCalendar();
    await loadExtendedInfo(); // Load Program Info after main promotion data
}

async function loadPromotion() {
    try {
        const response = await fetch(`${API_URL}/api/promotions/${promotionId}`);

        if (response.ok) {
            const promotion = await response.json();
            document.getElementById('promotion-title').textContent = `¬°Hola Coder! üëã - ${promotion.name}`;
            document.title = `${promotion.name} - Bootcamp`;

            // Store promotion data globally for module access
            window.publicPromotionData = promotion;

            generateGanttChart(promotion);
        }
    } catch (error) {
        console.error('Error loading promotion:', error);
    }
}

async function loadModules() {
    try {
        const response = await fetch(`${API_URL}/api/promotions/${promotionId}`);

        if (response.ok) {
            const promotion = await response.json();
            generateGanttChart(promotion);
        }
    } catch (error) {
        console.error('Error loading modules:', error);
    }
}

function generateGanttChart(promotion) {
    const table = document.getElementById('gantt-table');
    table.innerHTML = '';

    const weeks = promotion.weeks || 0;
    const modules = promotion.modules || [];
    const employability = promotion.employability || [];

    if (modules.length === 0) {
        table.innerHTML = '<tr><td class="text-muted">No modules configured</td></tr>';
        return;
    }

    // Add responsive wrapper styling to the table
    table.style.fontSize = '0.75rem';
    table.className = 'table table-sm table-bordered';

    // Ensure parent container has proper overflow handling
    const tableContainer = table.closest('.table-responsive') || table.parentElement;
    if (tableContainer) {
        tableContainer.style.overflowX = 'auto';
        tableContainer.style.maxWidth = '100%';
    }

    // Helper function to get month for a week (1-indexed)
    function getMonthForWeek(weekNum) {
        return Math.ceil(weekNum / 4);
    }

    // Create month header
    const monthRow = document.createElement('tr');
    const monthHeaderCell = document.createElement('th');
    monthHeaderCell.innerHTML = '<strong>Meses</strong>';
    monthHeaderCell.style.minWidth = '150px';
    monthHeaderCell.style.maxWidth = '200px';
    monthHeaderCell.style.fontSize = '0.7rem';
    monthRow.appendChild(monthHeaderCell);

    let currentMonth = 0;
    let monthSpan = 0;
    let monthCell = null;

    for (let i = 1; i <= weeks; i++) {
        const month = getMonthForWeek(i);

        if (month !== currentMonth) {
            if (monthCell) {
                monthCell.colSpan = monthSpan;
            }
            currentMonth = month;
            monthCell = document.createElement('th');
            monthCell.innerHTML = `<strong>M${month}</strong>`;
            monthCell.style.textAlign = 'center';
            monthCell.style.fontSize = '0.65rem';
            monthCell.style.minWidth = '20px';
            monthCell.style.padding = '2px';
            monthRow.appendChild(monthCell);
            monthSpan = 1;
        } else {
            monthSpan++;
        }
    }
    if (monthCell) {
        monthCell.colSpan = monthSpan;
    }

    table.appendChild(monthRow);

    // Create week header
    const headerRow = document.createElement('tr');
    const weekHeaderCell = document.createElement('th');
    weekHeaderCell.innerHTML = 'Semanas:';
    weekHeaderCell.style.minWidth = '150px';
    weekHeaderCell.style.maxWidth = '200px';
    weekHeaderCell.style.fontSize = '0.7rem';
    headerRow.appendChild(weekHeaderCell);

    for (let i = 1; i <= weeks; i++) {
        const th = document.createElement('th');
        th.textContent = `${i}`;
        th.style.textAlign = 'center';
        th.style.fontSize = '0.6rem';
        th.style.minWidth = '20px';
        th.style.maxWidth = '25px';
        th.style.padding = '2px';
        th.style.writingMode = 'vertical-rl';
        th.style.textOrientation = 'mixed';
        headerRow.appendChild(th);
    }

    table.appendChild(headerRow);

    // Sesiones Empleabilidad before modules
    if (employability && employability.length > 0) {

        // Employability items
        employability.forEach((item) => {
            const itemRow = document.createElement('tr');
            const itemLabel = document.createElement('td');
            const itemUrl = item.url ? `<a href="${escapeHtml(item.url)}" target="_blank" class="text-decoration-none">${escapeHtml(item.name)}</a>` : escapeHtml(item.name);
            itemLabel.innerHTML = `<small><strong>Sesiones Empleabilidad:</strong> ${itemUrl}</small>`;
            itemLabel.style.minWidth = '150px';
            itemLabel.style.maxWidth = '200px';
            itemLabel.style.fontSize = '0.65rem';
            itemLabel.style.padding = '4px';
            itemRow.appendChild(itemLabel);

            // Convert months to weeks: startMonth is 1-indexed
            const startWeek = (item.startMonth - 1) * 4;
            const endWeek = startWeek + (item.duration * 4);

            for (let i = 0; i < weeks; i++) {
                const cell = document.createElement('td');
                cell.style.textAlign = 'center';
                cell.style.height = '25px';
                cell.style.minWidth = '20px';
                cell.style.maxWidth = '25px';
                cell.style.padding = '1px';
                cell.style.fontSize = '0.7rem';

                if (i >= startWeek && i < endWeek) {
                    cell.style.backgroundColor = '#fff3cd';
                }
                itemRow.appendChild(cell);
            }
            table.appendChild(itemRow);
        });
    }

    // Create rows for modules (below Sesiones Empleabilidad)
    let weekCounter = 0;
    modules.forEach((module, index) => {
        const moduleId = `module-${index}`;

        // Main module row with dropdown toggle
        const row = document.createElement('tr');
        const nameCell = document.createElement('td');
        nameCell.innerHTML = `
            <div class="d-flex align-items-center">
                <button class="btn btn-link p-0 me-1" type="button" data-bs-toggle="collapse" data-bs-target="#${moduleId}" aria-expanded="false" style="font-size: 0.7rem;">
                    <i class="bi bi-chevron-right" id="chevron-${moduleId}"></i>
                </button>
                <strong style="font-size: 0.7rem;">M${index + 1}: ${escapeHtml(module.name)}</strong>
            </div>
        `;
        nameCell.style.minWidth = '150px';
        nameCell.style.maxWidth = '200px';
        nameCell.style.padding = '4px';
        row.appendChild(nameCell);

        for (let i = 0; i < weeks; i++) {
            const cell = document.createElement('td');
            cell.style.textAlign = 'center';
            cell.style.height = '30px';
            cell.style.minWidth = '20px';
            cell.style.maxWidth = '25px';
            cell.style.padding = '1px';
            cell.style.fontSize = '0.7rem';

            if (i >= weekCounter && i < weekCounter + module.duration) {
                cell.style.backgroundColor = '#667eea';
                cell.style.color = 'white'
            }

            row.appendChild(cell);
        }

        table.appendChild(row);

        // Create collapsible section for courses and projects
        const hasSubItems = (module.courses && module.courses.length > 0) || (module.projects && module.projects.length > 0);

        if (hasSubItems) {
            const collapseContainer = document.createElement('tbody');
            collapseContainer.className = 'collapse';
            collapseContainer.id = moduleId;

            // Create rows for courses
            if (module.courses && module.courses.length > 0) {
                module.courses.forEach(courseObj => {
                    const isObj = courseObj && typeof courseObj === 'object';
                    const courseName = isObj ? (courseObj.name || 'Unnamed') : String(courseObj);
                    const courseUrl = isObj ? (courseObj.url || '') : '';
                    const courseDur = isObj ? (Number(courseObj.duration) || 1) : 1;
                    const courseOff = isObj ? (Number(courseObj.startOffset) || 0) : 0;

                    const coursesRow = document.createElement('tr');
                    const coursesLabel = document.createElement('td');
                    const courseLink = courseUrl ? `<a href="${escapeHtml(courseUrl)}" target="_blank" class="text-decoration-none"> ${escapeHtml(courseName)}</a>` : ` ${escapeHtml(courseName)}`;
                    coursesLabel.innerHTML = `<small style="margin-left: 1.5rem; font-size: 0.6rem;">${courseLink}</small>`;
                    coursesLabel.style.minWidth = '150px';
                    coursesLabel.style.maxWidth = '200px';
                    coursesLabel.style.padding = '2px';
                    coursesRow.appendChild(coursesLabel);

                    const absoluteStart = weekCounter + courseOff;
                    const absoluteEnd = absoluteStart + courseDur;

                    for (let i = 0; i < weeks; i++) {
                        const cell = document.createElement('td');
                        cell.style.minWidth = '20px';
                        cell.style.maxWidth = '25px';
                        cell.style.padding = '1px';
                        cell.style.height = '20px';
                        cell.style.fontSize = '0.6rem';
                        if (i >= absoluteStart && i < absoluteEnd) {
                            cell.style.backgroundColor = '#d1e7dd';

                        }
                        coursesRow.appendChild(cell);
                    }
                    collapseContainer.appendChild(coursesRow);
                });
            }

            // Create rows for projects
            if (module.projects && module.projects.length > 0) {
                module.projects.forEach(projectObj => {
                    const isObj = projectObj && typeof projectObj === 'object';
                    const projectName = isObj ? (projectObj.name || 'Unnamed') : String(projectObj);
                    const projectUrl = isObj ? (projectObj.url || '') : '';
                    const projectDur = isObj ? (Number(projectObj.duration) || 1) : 1;
                    const projectOff = isObj ? (Number(projectObj.startOffset) || 0) : 0;

                    const projectsRow = document.createElement('tr');
                    const projectsLabel = document.createElement('td');
                    const projectLink = projectUrl ? `<a href="${escapeHtml(projectUrl)}" target="_blank" class="text-decoration-none">${escapeHtml(projectName)}</a>` : `${escapeHtml(projectName)}`;
                    projectsLabel.innerHTML = `<small style="margin-left: 1.5rem; font-size: 0.6rem;"> ${projectLink}</small>`;
                    projectsLabel.style.minWidth = '150px';
                    projectsLabel.style.maxWidth = '200px';
                    projectsLabel.style.padding = '2px';
                    projectsRow.appendChild(projectsLabel);

                    const absoluteStart = weekCounter + projectOff;
                    const absoluteEnd = absoluteStart + projectDur;

                    for (let i = 0; i < weeks; i++) {
                        const cell = document.createElement('td');
                        cell.style.minWidth = '20px';
                        cell.style.maxWidth = '25px';
                        cell.style.padding = '1px';
                        cell.style.height = '20px';
                        cell.style.fontSize = '0.6rem';
                        if (i >= absoluteStart && i < absoluteEnd) {
                            cell.style.backgroundColor = '#fce4e4';

                        }
                        projectsRow.appendChild(cell);
                    }
                    collapseContainer.appendChild(projectsRow);
                });
            }

            table.appendChild(collapseContainer);

            // Add event listener for chevron rotation
            const toggleButton = nameCell.querySelector(`[data-bs-target="#${moduleId}"]`);
            const chevron = document.getElementById(`chevron-${moduleId}`);

            toggleButton.addEventListener('click', function () {
                setTimeout(() => {
                    if (collapseContainer.classList.contains('show')) {
                        chevron.className = 'bi bi-chevron-down';
                    } else {
                        chevron.className = 'bi bi-chevron-right';
                    }
                }, 10);
            });
        }

        // Correct position for weekCounter update
        weekCounter += module.duration;
    });
}

async function loadQuickLinks() {
    try {
        const response = await fetch(`${API_URL}/api/promotions/${promotionId}/quick-links`);

        if (response.ok) {
            const links = await response.json();
            displayQuickLinks(links);
        }
    } catch (error) {
        console.error('Error loading quick links:', error);
    }
}

function displayQuickLinks(links) {
    const list = document.getElementById('quick-links-list');
    list.innerHTML = '';

    if (links.length === 0) {
        document.getElementById('quick-links').classList.add('hidden');
        return;
    }

    links.forEach(link => {
        const col = document.createElement('div');
        col.className = 'col-md-6 col-lg-3';
        col.innerHTML = `
            <div class="d-grid gap-2">
                <a href="${escapeHtml(link.url)}" target="_blank" class="btn btn-outline-primary">
                    <i class="bi bi-box-arrow-up-right me-2"></i> ${escapeHtml(link.name)}
                </a>
            </div>
        `;
        list.appendChild(col);
    });
}

async function loadSections() {
    try {
        const response = await fetch(`${API_URL}/api/promotions/${promotionId}/sections`);

        if (response.ok) {
            const sections = await response.json();
            displaySections(sections);
        }
    } catch (error) {
        console.error('Error loading sections:', error);
    }
}

function displaySections(sections) {
    const container = document.getElementById('sections-container');
    container.innerHTML = '';

    sections.forEach((section, index) => {
        const col = document.createElement('div');
        col.className = 'col-md-12';
        col.id = section.id;
        col.innerHTML = `
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title section-title">
                        <i class="bi bi-file-text me-2"></i> ${escapeHtml(section.title)}
                    </h5>
                    <p class="card-text">${escapeHtml(section.content).replace(/\n/g, '<br>')}</p>
                </div>
            </div>
        `;
        container.appendChild(col);
    });

    // Update sidebar navigation
    updateSidebar(sections);
}

function updateSidebar(sections) {
    const nav = document.getElementById('sidebar-nav');
    nav.innerHTML = `
        <li class="nav-item"><a class="nav-link" href="#roadmap"><i class="bi bi-map me-2"></i>Roadmap</a></li>
    `;

    sections.forEach(section => {
        const li = document.createElement('li');
        li.className = 'nav-item';
        li.innerHTML = `<a class="nav-link" href="#${section.id}"><i class="bi bi-file-text me-2"></i>${escapeHtml(section.title)}</a>`;
        nav.appendChild(li);
    });

    // Note: Program Info sections will be added by updateSidebarWithExtendedInfo()

    const li = document.createElement('li');
    li.className = 'nav-item';
    li.innerHTML = '<a class="nav-link" href="#quick-links"><i class="bi bi-lightning-charge me-2"></i>Quick Links</a>';
    nav.appendChild(li);
}

// Update sidebar with only the Program Info sections that have data
function updateSidebarWithExtendedInfo(info) {
    const nav = document.getElementById('sidebar-nav');
    if (!nav) {
        console.error('Sidebar navigation not found');
        return;
    }

    console.log('Updating sidebar with extended info:', info);

    // Find roadmap item as reference point for p√≠ldoras
    const roadmapAnchor = nav.querySelector('a[href="#roadmap"]');
    const roadmapItem = roadmapAnchor ? roadmapAnchor.parentElement : null;

    // Find Quick Links item as reference point for other sections
    const quickLinksAnchor = nav.querySelector('a[href="#quick-links"]');
    const quickLinksItem = quickLinksAnchor ? quickLinksAnchor.parentElement : null;

    console.log('Roadmap item found:', !!roadmapItem);
    console.log('Quick links item found:', !!quickLinksItem);

    // Add P√≠ldoras right after Roadmap if they exist
    if ((Array.isArray(info.pildoras) && info.pildoras.length > 0) ||
        (Array.isArray(info.modulesPildoras) && info.modulesPildoras.some(mp => Array.isArray(mp.pildoras) && mp.pildoras.length > 0))) {
        console.log('Adding pildoras section to sidebar right after roadmap');
        const pildorasLi = document.createElement('li');
        pildorasLi.className = 'nav-item';
        pildorasLi.innerHTML = '<a class="nav-link" href="#pildoras"><i class="bi bi-lightbulb me-2"></i>P√≠ldoras</a>';

        if (roadmapItem) {
            roadmapItem.insertAdjacentElement('afterend', pildorasLi);
        } else if (quickLinksItem) {
            nav.insertBefore(pildorasLi, quickLinksItem);
        } else {
            nav.appendChild(pildorasLi);
        }

        // Add Calendar right after P√≠ldoras
        console.log('Adding calendar section to sidebar right after pildoras');
        const calendarLi = document.createElement('li');
        calendarLi.className = 'nav-item';
        calendarLi.innerHTML = '<a class="nav-link" href="#calendar"><i class="bi bi-calendar me-2"></i>Calendario</a>';

        pildorasLi.insertAdjacentElement('afterend', calendarLi);
    }

    // Add other Program Info sections before Quick Links
    if (info.schedule && hasScheduleData(info.schedule)) {
        console.log('Adding schedule section to sidebar');
        const li = document.createElement('li');
        li.className = 'nav-item';
        li.innerHTML = '<a class="nav-link" href="#horario"><i class="bi bi-clock me-2"></i>Horario</a>';

        if (quickLinksItem) {
            nav.insertBefore(li, quickLinksItem);
        } else {
            nav.appendChild(li);
        }
    }

    if (info.team && info.team.length > 0) {
        console.log('Adding team section to sidebar');
        const li = document.createElement('li');
        li.className = 'nav-item';
        li.innerHTML = '<a class="nav-link" href="#equipo"><i class="bi bi-people me-2"></i>Equipo</a>';

        if (quickLinksItem) {
            nav.insertBefore(li, quickLinksItem);
        } else {
            nav.appendChild(li);
        }
    }

    if (info.evaluation && info.evaluation.trim()) {
        console.log('Adding evaluation section to sidebar');
        const li = document.createElement('li');
        li.className = 'nav-item';
        li.innerHTML = '<a class="nav-link" href="#evaluacion"><i class="bi bi-clipboard-check me-2"></i>Evaluaci√≥n</a>';

        if (quickLinksItem) {
            nav.insertBefore(li, quickLinksItem);
        } else {
            nav.appendChild(li);
        }
    }

    if (info.resources && info.resources.length > 0) {
        console.log('Adding resources section to sidebar');
        const li = document.createElement('li');
        li.className = 'nav-item';
        li.innerHTML = '<a class="nav-link" href="#resources"><i class="bi bi-tools me-2"></i>Recursos</a>';

        if (quickLinksItem) {
            nav.insertBefore(li, quickLinksItem);
        } else {
            nav.appendChild(li);
        }
    }

    if (Array.isArray(info.competences) && info.competences.length > 0) {
        console.log('Adding competences section to sidebar');
        const li = document.createElement('li');
        li.className = 'nav-item';
        li.innerHTML = '<a class="nav-link" href="#competences-section"><i class="bi bi-award me-2"></i>Competencias</a>';

        if (quickLinksItem) {
            nav.insertBefore(li, quickLinksItem);
        } else {
            nav.appendChild(li);
        }
    }
}

async function loadCalendar() {
    try {
        const response = await fetch(`${API_URL}/api/promotions/${promotionId}/calendar`);

        if (response.ok) {
            const calendar = await response.json();
            const calendarCard = document.getElementById('calendar').querySelector('.card');
            calendarCard.classList.remove('hidden');
            document.getElementById('calendar-iframe').src = `https://calendar.google.com/calendar/embed?src=${encodeURIComponent(calendar.googleCalendarId)}&ctz=Europe/Madrid`;
        }
    } catch (error) {
        console.error('Error loading calendar:', error);
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Helper function to apply colors to cells based on content
function applyCellColors(cellContent, cellType) {
    let baseStyle = 'border: 1px solid #dee2e6; text-align: center; vertical-align: middle; padding: 8px;';

    if (cellType === 'presentacion') {
        if (cellContent.toLowerCase().includes('presencial')) {
            baseStyle += ' background-color: #d4edda; color: #155724;';
        } else if (cellContent.toLowerCase().includes('virtual')) {
            baseStyle += ' background-color: #cce5ff; color: #004085;';
        }
    } else if (cellType === 'estado') {
        if (cellContent.toLowerCase().includes('presentada') && !cellContent.toLowerCase().includes('no')) {
            baseStyle += ' background-color: #d4edda; color: #155724;';
        } else if (cellContent.toLowerCase().includes('no presentada')) {
            baseStyle += ' background-color: #f8d7da; color: #721c24;';
        }
    }

    return baseStyle;
}

// Load Program Info (Extended Info) data
async function loadExtendedInfo() {
    try {
        console.log('Loading extended info for promotion:', promotionId);
        const response = await fetch(`${API_URL}/api/promotions/${promotionId}/extended-info?t=${Date.now()}`);

        if (response.ok) {
            const info = await response.json();
            console.log('Extended info loaded:', info);
            console.log('Self-assignment status:', info.pildorasAssignmentOpen);

            // If self-assignment is open, fetch students list
            if (info.pildorasAssignmentOpen) {
                console.log('Self-assignment is open, loading students...');
                await loadPublicStudents();
            }

            displayExtendedInfo(info);
            displayPublicCompetences(info.competences || []);
        } else {
            console.log('No extended info found or error loading:', response.status);
        }
    } catch (error) {
        console.error('Error loading extended info:', error);
    }
}

async function loadPublicStudents() {
    try {
        const response = await fetch(`${API_URL}/api/promotions/${promotionId}/public-students`);
        if (response.ok) {
            window.publicStudents = await response.json();
            console.log('Public students loaded:', window.publicStudents.length);
        }
    } catch (error) {
        console.error('Error loading public students:', error);
    }
}

// ‚îÄ‚îÄ‚îÄ Competencias p√∫blicas ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _publicCompetencesAll = [];

function displayPublicCompetences(competences) {
    _publicCompetencesAll = Array.isArray(competences) ? competences : [];
    const section = document.getElementById('competences-section');
    if (!section) return;

    if (!_publicCompetencesAll.length) {
        section.style.display = 'none';
        return;
    }

    section.style.display = '';

    // Build area filter options
    const areaFilter = document.getElementById('public-competences-area-filter');
    if (areaFilter) {
        const areas = [...new Set(_publicCompetencesAll.map(c => c.area).filter(Boolean))];
        const existingOptions = areaFilter.querySelectorAll('option:not([value=""])');
        existingOptions.forEach(o => o.remove());
        areas.forEach(area => {
            const opt = document.createElement('option');
            opt.value = area;
            opt.textContent = area;
            areaFilter.appendChild(opt);
        });
    }

    _renderPublicCompetences('');
}

function filterPublicCompetences() {
    const filterVal = document.getElementById('public-competences-area-filter')?.value || '';
    _renderPublicCompetences(filterVal);
}

function _renderPublicCompetences(filterArea) {
    const container = document.getElementById('public-competences-list');
    if (!container) return;

    const filtered = filterArea
        ? _publicCompetencesAll.filter(c => c.area === filterArea)
        : _publicCompetencesAll;

    if (!filtered.length) {
        container.innerHTML = '<p class="text-muted">No hay competencias en esta √°rea.</p>';
        return;
    }

    const areaColorMap = {
        'web': 'primary', 'ai': 'dark', 'accessibility': 'info',
        'green': 'success', 'inmersivo': 'warning'
    };
    const levelColorMap = { 1: 'secondary', 2: 'warning', 3: 'primary', 4: 'success' };

    const items = filtered.map((comp, i) => {
        const areaColor = areaColorMap[comp.area] || 'secondary';
        const selectedCount = (comp.selectedTools || []).length;
        const allCount = (comp.allTools || comp.selectedTools || []).length;
        const levelsCount = (comp.levels || []).length;

        const startModuleBadge = comp.startModule
            ? `<span class="badge bg-light text-dark border ms-2 small"><i class="bi bi-play-circle me-1 text-primary"></i>${escapeHtml(comp.startModule.name)}</span>`
            : '';

        const toolBadges = (comp.selectedTools || []).map(t =>
            `<span class="badge bg-light text-dark border me-1 mb-1"><i class="bi bi-tools me-1 opacity-50"></i>${escapeHtml(t)}</span>`
        ).join('');

        const levelRows = (comp.levels || []).map(l => `
            <div class="d-flex align-items-start gap-2 mb-2">
                <span class="badge bg-${levelColorMap[l.level] || 'secondary'} flex-shrink-0" style="min-width:2rem;text-align:center;">${l.level}</span>
                <div>
                    <strong class="small">${escapeHtml(l.description)}</strong>
                    <ul class="mb-0 ps-3 small text-muted">
                        ${(l.indicators || []).map(ind => `<li>${escapeHtml(ind)}</li>`).join('')}
                    </ul>
                </div>
            </div>`).join('');

        return `
        <div class="accordion-item border-start border-4 border-${areaColor}">
            <h2 class="accordion-header" id="pub-comp-header-${i}">
                <button class="accordion-button collapsed py-2" type="button"
                    data-bs-toggle="collapse" data-bs-target="#pub-comp-body-${i}"
                    aria-expanded="false" aria-controls="pub-comp-body-${i}">
                    <div class="d-flex align-items-center flex-wrap gap-2 w-100 me-3">
                        <span class="badge bg-${areaColor}">${escapeHtml(comp.area)}</span>
                        <strong>${escapeHtml(comp.name)}</strong>
                        ${startModuleBadge}
                        <span class="ms-auto d-flex gap-2 small text-muted">
                            <span title="Herramientas"><i class="bi bi-tools me-1"></i>${selectedCount}</span>
                            <span title="Niveles"><i class="bi bi-bar-chart-steps me-1"></i>${levelsCount}</span>
                        </span>
                    </div>
                </button>
            </h2>
            <div id="pub-comp-body-${i}" class="accordion-collapse collapse"
                aria-labelledby="pub-comp-header-${i}" data-bs-parent="#public-competences-accordion">
                <div class="accordion-body pt-2 pb-3">
                    ${comp.description ? `<p class="text-muted small mb-3">${escapeHtml(comp.description)}</p>` : ''}
                    ${comp.startModule ? `
                    <div class="mb-3 p-2 bg-light rounded border d-inline-flex align-items-center gap-2">
                        <i class="bi bi-play-circle text-primary"></i>
                        <span class="small fw-semibold">Empieza a evaluarse en:</span>
                        <span class="badge bg-primary">${escapeHtml(comp.startModule.name)}</span>
                    </div>` : ''}
                    <div class="row g-3">
                        <div class="col-lg-6">
                            <h6 class="small text-uppercase text-muted mb-2">
                                <i class="bi bi-bar-chart-steps me-1"></i>Niveles e indicadores
                            </h6>
                            ${levelRows || '<span class="text-muted small fst-italic">Sin niveles definidos.</span>'}
                        </div>
                        <div class="col-lg-6">
                            <h6 class="small text-uppercase text-muted mb-2">
                                <i class="bi bi-tools me-1"></i>Herramientas
                            </h6>
                            ${toolBadges || '<span class="text-muted small fst-italic">No especificadas.</span>'}
                        </div>
                    </div>
                </div>
            </div>
        </div>`;
    }).join('');

    container.innerHTML = `<div class="accordion" id="public-competences-accordion">${items}</div>`;
}


// Display Program Info sections
function displayExtendedInfo(info) {
    const sectionsContainer = document.getElementById('sections-container');
    const roadmapSection = document.getElementById('roadmap');

    // Store extended info globally for p√≠ldoras navigation
    window.publicPromotionExtendedInfo = info;

    // Clear existing extended info sections to avoid duplicates on reload
    document.querySelectorAll('#pildoras, #horario, #equipo, #recursos, #evaluacion').forEach(el => el.remove());

    // Create Program Info sections
    const programInfoSections = createProgramInfoSections(info);

    // Find p√≠ldoras section and insert it right after roadmap
    const pildorasSection = programInfoSections.find(section => section.id === 'pildoras');
    if (pildorasSection && roadmapSection) {
        // Insert p√≠ldoras right after roadmap
        roadmapSection.insertAdjacentElement('afterend', pildorasSection);

        // Remove p√≠ldoras from the regular sections array
        const otherSections = programInfoSections.filter(section => section.id !== 'pildoras');

        // Add remaining sections to sections container
        otherSections.forEach(section => {
            sectionsContainer.appendChild(section);
        });
    } else {
        // If no p√≠ldoras section, add all sections normally
        programInfoSections.forEach(section => {
            sectionsContainer.appendChild(section);
        });
    }

    // Update sidebar to include the new sections
    updateSidebarWithExtendedInfo(info);

    console.log('Extended info sections displayed:', programInfoSections.length);
}

// Create Program Info sections HTML
function createProgramInfoSections(info) {
    const sections = [];

    // Check if we have module-based p√≠ldoras with actual content
    const modulesWithActualPildoras = Array.isArray(info.modulesPildoras) ?
        info.modulesPildoras.filter(mp => Array.isArray(mp.pildoras) && mp.pildoras.length > 0) : [];

    // P√≠ldoras Section (Legacy format) - Show if legacy exists AND (no module data exists OR modules are empty)
    if (Array.isArray(info.pildoras) && info.pildoras.length > 0 && modulesWithActualPildoras.length === 0) {
        console.log('Creating Legacy p√≠ldoras section (no module-based p√≠ldoras found)');
        const pildorasSection = document.createElement('div');
        pildorasSection.className = 'col-md-12';
        pildorasSection.id = 'pildoras';

        // Find the next upcoming date for legacy format
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        let nextDateIndex = -1;
        let nextDate = null;

        for (let i = 0; i < info.pildoras.length; i++) {
            const pildora = info.pildoras[i];
            if (pildora.date && pildora.date.trim()) {
                const pildoraDate = new Date(pildora.date);
                pildoraDate.setHours(0, 0, 0, 0);

                // Check if this date is today or in the future
                if (pildoraDate >= today) {
                    if (!nextDate || pildoraDate < nextDate) {
                        nextDate = pildoraDate;
                        nextDateIndex = i;
                    }
                }
            }
        }

        const rows = info.pildoras.map((p, index) => {
            const mode = p.mode || '';
            const date = p.date || '';
            const title = p.title || '';
            const students = Array.isArray(p.students) ? p.students : [];
            const studentsText = students.length
                ? students.map(s => `${(s.name || '').trim()} ${(s.lastname || '').trim()}`.trim()).join(', ')
                : 'Desierta';
            const status = p.status || '';

            // Assignment UI for Legacy
            let assignmentCell = '';
            if (info.pildorasAssignmentOpen) {
                const studentOptions = (window.publicStudents || [])
                    .map(s => `<option value="${s.id}">${s.name} ${s.lastname}</option>`)
                    .join('');

                assignmentCell = `
                    <td style="width: 15%; border: 1px solid #dee2e6; text-align: center; vertical-align: middle; padding: 8px;">
                        <div class="d-flex flex-column gap-1">
                            <select class="form-select form-select-sm coder-select-legacy-${index}">
                                <option value="">Selecciona Coder...</option>
                                ${studentOptions}
                            </select>
                            <button class="btn btn-xs btn-primary py-0" style="font-size: 0.7rem;" onclick="window.selfAssignPildoraLegacy(${index})">
                                <i class="bi bi-person-plus"></i> Apuntarse
                            </button>
                        </div>
                    </td>
                `;
            }

            // Apply orange background for the next upcoming date
            const isNextDate = index === nextDateIndex;
            const maxVisible = 5;
            const isHidden = index >= maxVisible;
            const rowClass = isHidden ? 'pildora-table-row-hidden' : '';

            if (isNextDate) {
                const orangeStyle = 'border: 1px solid #dee2e6; text-align: center; vertical-align: middle; padding: 8px; background-color: #ff6600; color: white;';
                const orangeStyleLeft = 'border: 1px solid #dee2e6; text-align: left; vertical-align: middle; padding: 8px; background-color: #ff6600; color: white;';

                return `
                    <tr class="${rowClass}">
                        <td style="width: 15%; ${orangeStyle}">${escapeHtml(mode)}</td>
                        <td style="width: 15%; ${orangeStyle}">${escapeHtml(date)}</td>
                        <td style="width: 25%; ${orangeStyleLeft}">${escapeHtml(title)}</td>
                        <td style="width: 20%; ${orangeStyleLeft}">${escapeHtml(studentsText)}</td>
                        <td style="width: 10%; ${orangeStyle}">${escapeHtml(status)}</td>
                        ${assignmentCell}
                    </tr>
                `;
            } else {
                return `
                    <tr class="${rowClass}">
                        <td style="width: 15%; ${applyCellColors(mode, 'presentacion')}">${escapeHtml(mode)}</td>
                        <td style="width: 15%; border: 1px solid #dee2e6; text-align: center; vertical-align: middle; padding: 8px;">${escapeHtml(date)}</td>
                        <td style="width: 25%; border: 1px solid #dee2e6; text-align: left; vertical-align: middle; padding: 8px;">${escapeHtml(title)}</td>
                        <td style="width: 20%; border: 1px solid #dee2e6; text-align: left; vertical-align: middle; padding: 8px;">${escapeHtml(studentsText)}</td>
                        <td style="width: 10%; ${applyCellColors(status, 'estado')}">${escapeHtml(status)}</td>
                        ${assignmentCell}
                    </tr>
                `;
            }
        }).join('');

        const maxVisible = 5;
        const showExpandButton = info.pildoras.length > maxVisible;
        
        pildorasSection.innerHTML = `
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="card-title section-title mb-0">
                            <i class="bi bi-lightbulb me-2"></i>P√≠ldoras (Formato Legacy)
                            ${info.pildorasAssignmentOpen ? '<span class="badge bg-success ms-2" style="font-size: 0.7rem;">Auto-asignaci√≥n Abierta</span>' : ''}
                        </h5>
                        <div class="alert alert-info mb-0 py-2 px-3">
                            <small><i class="bi bi-info-circle me-1"></i>Para ver navegaci√≥n por m√≥dulos, configure p√≠ldoras por m√≥dulo en el dashboard del profesor</small>
                        </div>
                    </div>
                    <div class="table-responsive mt-3">
                        <table class="table table-sm table-bordered" style="border-color: #dee2e6;">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 15%; border: 1px solid #dee2e6; text-align: center; vertical-align: middle;">Presentaci√≥n</th>
                                    <th style="width: 15%; border: 1px solid #dee2e6; text-align: center; vertical-align: middle;">Fecha</th>
                                    <th style="width: 25%; border: 1px solid #dee2e6; text-align: center; vertical-align: middle;">P√≠ldora</th>
                                    <th style="width: 20%; border: 1px solid #dee2e6; text-align: center; vertical-align: middle;">Coder</th>
                                    <th style="width: 10%; border: 1px solid #dee2e6; text-align: center; vertical-align: middle;">Estado</th>
                                    ${info.pildorasAssignmentOpen ? '<th style="width: 15%; border: 1px solid #dee2e6; text-align: center; vertical-align: middle;">Acci√≥n</th>' : ''}
                                </tr>
                            </thead>
                            <tbody>
                                ${rows}
                            </tbody>
                        </table>
                    </div>
                    ${showExpandButton ? `
                        <div class="pildora-table-expand-row">
                            <button class="btn btn-link" onclick="window.togglePildorasTableExpandLegacy()">
                                <span class="pildora-expand-text-legacy">Ver todas las p√≠ldoras</span>
                                <i class="bi bi-chevron-down pildora-expand-icon-legacy"></i>
                            </button>
                        </div>
                    ` : ''}
                </div>
            </div>
        `;
        sections.push(pildorasSection);
    }

    // P√≠ldoras Section (Module-based format) - MOVED TO FIRST POSITION
    if (modulesWithActualPildoras.length > 0) {
        console.log('Creating Module-based p√≠ldoras section with navigation arrows');
        console.log('Modules with p√≠ldoras:', modulesWithActualPildoras);

        // Get promotion modules to match with module names
        const promotionModulesData = window.publicPromotionData?.modules || [];
        console.log('Promotion modules:', promotionModulesData);

        // enrich with promotion module data
        const modulesWithPildoras = modulesWithActualPildoras
            .map(moduleData => {
                // Find matching promotion module to get correct name
                const promotionModule = promotionModulesData.find(pm => pm.id === moduleData.moduleId);
                return {
                    ...moduleData,
                    moduleName: promotionModule?.name || moduleData.moduleName || 'Unknown Module'
                };
            });

        console.log('Filtered modules with p√≠ldoras:', modulesWithPildoras);

        if (modulesWithPildoras.length > 0) {
            const pildorasSection = document.createElement('div');
            pildorasSection.className = 'col-md-12';
            pildorasSection.id = 'pildoras';

            // Initialize with first module
            let currentModuleIndex = 0;

            function renderPildorasTable() {
                console.log('Rendering p√≠ldoras table. Assignment open:', info.pildorasAssignmentOpen);
                console.log('Public students available:', window.publicStudents?.length);
                const currentModule = modulesWithPildoras[currentModuleIndex];
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                // Find the next upcoming date (closest to today)
                let nextDateIndex = -1;
                let nextDate = null;

                for (let i = 0; i < currentModule.pildoras.length; i++) {
                    const pildora = currentModule.pildoras[i];
                    if (pildora.date && pildora.date.trim()) {
                        const pildoraDate = new Date(pildora.date);
                        pildoraDate.setHours(0, 0, 0, 0);

                        // Check if this date is today or in the future
                        if (pildoraDate >= today) {
                            if (!nextDate || pildoraDate < nextDate) {
                                nextDate = pildoraDate;
                                nextDateIndex = i;
                            }
                        }
                    }
                }

                const rows = currentModule.pildoras.map((p, index) => {
                    const mode = p.mode || '';
                    const date = p.date || '';
                    const title = p.title || '';
                    const students = Array.isArray(p.students) ? p.students : [];
                    const studentsText = students.length
                        ? students.map(s => `${(s.name || '').trim()} ${(s.lastname || '').trim()}`.trim()).join(', ')
                        : 'Desierta';
                    const status = p.status || '';

                    // Assignment UI
                    let assignmentCell = '';
                    if (info.pildorasAssignmentOpen) {
                        const studentOptions = (window.publicStudents || [])
                            .map(s => `<option value="${s.id}">${s.name} ${s.lastname}</option>`)
                            .join('');

                        assignmentCell = `
                            <td style="width: 15%; border: 1px solid #dee2e6; text-align: center; vertical-align: middle; padding: 8px;">
                                <div class="d-flex flex-column gap-1">
                                    <select class="form-select form-select-sm coder-select-${index}">
                                        <option value="">Selecciona Coder...</option>
                                        ${studentOptions}
                                    </select>
                                    <button class="btn btn-xs btn-primary py-0" style="font-size: 0.7rem;" onclick="window.selfAssignPildora('${currentModule.moduleId}', ${index})">
                                        <i class="bi bi-person-plus"></i> Apuntarse
                                    </button>
                                </div>
                            </td>
                        `;
                    }

                    // Apply orange background for the next upcoming date
                    const isNextDate = index === nextDateIndex;
                    const maxVisible = 5;
                    const isHidden = index >= maxVisible;
                    const rowClass = isHidden ? 'pildora-table-row-hidden' : '';

                    // If this is the next date row, apply orange background to all cells
                    if (isNextDate) {
                        const orangeStyle = 'border: 1px solid #dee2e6; text-align: center; vertical-align: middle; padding: 8px; background-color: #ff6600; color: white;';
                        const orangeStyleLeft = 'border: 1px solid #dee2e6; text-align: left; vertical-align: middle; padding: 8px; background-color: #ff6600; color: white;';

                        return `
                            <tr class="${rowClass}">
                                <td style="width: 15%; ${orangeStyle}">${escapeHtml(mode)}</td>
                                <td style="width: 15%; ${orangeStyle}">${escapeHtml(date)}</td>
                                <td style="width: 30%; ${orangeStyleLeft}">${escapeHtml(title)}</td>
                                <td style="width: 20%; ${orangeStyleLeft}">${escapeHtml(studentsText)}</td>
                                <td style="width: 10%; ${orangeStyle}">${escapeHtml(status)}</td>
                                ${assignmentCell}
                            </tr>
                        `;
                    } else {
                        // Normal row with color coding for specific cells
                        return `
                            <tr class="${rowClass}">
                                <td style="width: 15%; ${applyCellColors(mode, 'presentacion')}">${escapeHtml(mode)}</td>
                                <td style="width: 15%; border: 1px solid #dee2e6; text-align: center; vertical-align: middle; padding: 8px;">${escapeHtml(date)}</td>
                                <td style="width: 30%; border: 1px solid #dee2e6; text-align: left; vertical-align: middle; padding: 8px;">${escapeHtml(title)}</td>
                                <td style="width: 20%; border: 1px solid #dee2e6; text-align: left; vertical-align: middle; padding: 8px;">${escapeHtml(studentsText)}</td>
                                <td style="width: 10%; ${applyCellColors(status, 'estado')}">${escapeHtml(status)}</td>
                                ${assignmentCell}
                            </tr>
                        `;
                    }
                }).join('');

                const tableContainer = pildorasSection.querySelector('.pildoras-table-container');
                if (tableContainer) {
                    const actionHeader = info.pildorasAssignmentOpen ? '<th style="width: 15%; border: 1px solid #dee2e6; text-align: center; vertical-align: middle;">Acci√≥n</th>' : '';
                    const maxVisible = 5;
                    const showExpandButton = currentModule.pildoras.length > maxVisible;
                    
                    tableContainer.innerHTML = `
                        <table class="table table-sm table-bordered" style="border-color: #dee2e6;">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 15%; border: 1px solid #dee2e6; text-align: center; vertical-align: middle;">Presentaci√≥n</th>
                                    <th style="width: 15%; border: 1px solid #dee2e6; text-align: center; vertical-align: middle;">Fecha</th>
                                    <th style="width: 30%; border: 1px solid #dee2e6; text-align: center; vertical-align: middle;">P√≠ldora</th>
                                    <th style="width: 20%; border: 1px solid #dee2e6; text-align: center; vertical-align: middle;">Coder</th>
                                    <th style="width: 10%; border: 1px solid #dee2e6; text-align: center; vertical-align: middle;">Estado</th>
                                    ${actionHeader}
                                </tr>
                            </thead>
                            <tbody>
                                ${rows}
                            </tbody>
                        </table>
                        ${showExpandButton ? `
                            <div class="pildora-table-expand-row">
                                <button class="btn btn-link pildora-expand-btn-${currentModule.moduleId}" onclick="window.togglePildorasTableExpand('${currentModule.moduleId}')">
                                    <span class="pildora-expand-text-${currentModule.moduleId}">Ver todas las p√≠ldoras</span>
                                    <i class="bi bi-chevron-down pildora-expand-icon-${currentModule.moduleId}"></i>
                                </button>
                            </div>
                        ` : ''}`
                    ;
                } else {
                    console.error('Table container not found!');
                }

                // Update navigation controls - Update button styles
                const countBadge = pildorasSection.querySelector('.module-pildoras-count');
                
                // Update all module buttons
                for (let i = 0; i < modulesWithPildoras.length; i++) {
                    const btn = pildorasSection.querySelector(`.module-selector-btn-${i}`);
                    if (btn) {
                        if (i === currentModuleIndex) {
                            btn.className = 'btn btn-sm module-selector-btn-' + i;
                            btn.classList.add('btn-primary');
                            btn.classList.remove('btn-outline-secondary');
                            btn.style.backgroundColor = '#ff6600';
                            btn.style.borderColor = '#ff6600';
                            btn.style.color = 'white';
                        } else {
                            btn.className = 'btn btn-sm module-selector-btn-' + i;
                            btn.classList.add('btn-outline-secondary');
                            btn.classList.remove('btn-primary');
                            btn.style.backgroundColor = '';
                            btn.style.borderColor = '';
                            btn.style.color = '';
                        }
                    }
                }
                
                if (countBadge) countBadge.textContent = currentModule.pildoras.length;

                console.log('Navigation controls updated successfully');
            }

            // Navigate to specific p√≠ldoras module
            window.navigateToPildorasModule = function(moduleIdx) {
                currentModuleIndex = moduleIdx;
                renderPildorasTable();
            };

            // Create the HTML structure with enhanced navigation - FORCE VISIBILITY
            pildorasSection.innerHTML = `
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="card-title section-title mb-0">
                                <i class="bi bi-lightbulb me-2"></i>P√≠ldoras
                                ${info.pildorasAssignmentOpen ? '<span class="badge bg-success ms-2" style="font-size: 0.7rem;">Auto-asignaci√≥n Abierta</span>' : ''}
                            </h5>
                            <div class="d-flex align-items-center gap-2">
                                <!-- Module buttons navigation -->
                                <div class="d-flex gap-2 flex-wrap">
                                    ${modulesWithPildoras.map((mod, idx) => `
                                        <button class="btn btn-sm module-selector-btn-${idx} ${idx === currentModuleIndex ? 'btn-primary' : 'btn-outline-secondary'}" 
                                                onclick="window.navigateToPildorasModule(${idx})"
                                                style="${idx === currentModuleIndex ? 'background-color: #ff6600; border-color: #ff6600; color: white;' : ''}">
                                            ${mod.moduleName}
                                        </button>
                                    `).join('')}
                                </div>
                                <div class="badge bg-info text-dark" style="font-size: 0.9rem;">
                                    <i class="bi bi-lightbulb-fill me-1"></i>
                                    <span class="module-pildoras-count">0</span> p√≠ldoras
                                </div>
                            </div>
                        </div>
                        <div class="table-responsive pildoras-table-container">
                            <!-- Table will be populated here -->
                        </div>
                    </div>
                </div>
            `;

            console.log('HTML structure created for module navigation');

            // Add navigation functions to window object to ensure global access
            window.navigatePildorasPrevious = function () {
                console.log('Navigate previous clicked, current index:', currentModuleIndex);
                if (currentModuleIndex > 0) {
                    currentModuleIndex--;
                    console.log('Moving to module index:', currentModuleIndex);
                    renderPildorasTable();
                }
            };

            window.selfAssignPildora = async function (mId, pIdx) {
                const selectEl = document.querySelector(`.coder-select-${pIdx}`);
                const sId = selectEl.value;
                if (!sId) {
                    alert('Por favor selecciona un Coder');
                    return;
                }

                try {
                    const response = await fetch(`${API_URL}/api/promotions/${promotionId}/pildoras-self-assign`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ moduleId: mId, pildoraIndex: pIdx, studentId: sId, action: 'add' })
                    });

                    if (response.ok) {
                        // Refresh data
                        const infoResponse = await fetch(`${API_URL}/api/promotions/${promotionId}/extended-info`);
                        if (infoResponse.ok) {
                            const newInfo = await infoResponse.json();
                            window.publicPromotionExtendedInfo = newInfo;

                            // Re-calculate modulesWithPildoras and update table
                            // (Actually it's better to just call loadExtendedInfo again to keep everything in sync)
                            loadExtendedInfo();
                        }
                    } else {
                        const error = await response.json();
                        alert(`Error: ${error.error}`);
                    }
                } catch (error) {
                    console.error('Error assigning p√≠ldora:', error);
                    alert('Error de conexi√≥n');
                }
            };

            window.selfAssignPildoraLegacy = async function (pIdx) {
                const selectEl = document.querySelector(`.coder-select-legacy-${pIdx}`);
                const sId = selectEl.value;
                if (!sId) {
                    alert('Por favor selecciona un Coder');
                    return;
                }

                try {
                    const response = await fetch(`${API_URL}/api/promotions/${promotionId}/pildoras-self-assign`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ pildoraIndex: pIdx, studentId: sId, action: 'add', isLegacy: true })
                    });

                    if (response.ok) {
                        loadExtendedInfo();
                    } else {
                        const error = await response.json();
                        alert(`Error: ${error.error}`);
                    }
                } catch (error) {
                    console.error('Error assigning p√≠ldora (legacy):', error);
                    alert('Error de conexi√≥n');
                }
            };

            window.navigatePildorasNext = function () {
                console.log('Navigate next clicked, current index:', currentModuleIndex);
                if (currentModuleIndex < modulesWithPildoras.length - 1) {
                    currentModuleIndex++;
                    console.log('Moving to module index:', currentModuleIndex);
                    renderPildorasTable();
                }
            };

            // Toggle expand/collapse for p√≠ldoras table
            window.togglePildorasTableExpand = function(moduleId) {
                const hiddenRows = document.querySelectorAll('.pildora-table-row-hidden');
                const btn = document.querySelector(`.pildora-expand-btn-${moduleId}`);
                const text = document.querySelector(`.pildora-expand-text-${moduleId}`);
                const icon = document.querySelector(`.pildora-expand-icon-${moduleId}`);
                
                if (!hiddenRows.length) return;
                
                const isCollapsed = hiddenRows[0].style.display !== 'table-row';
                hiddenRows.forEach(row => {
                    row.style.display = isCollapsed ? 'table-row' : 'none';
                });
                
                if (isCollapsed) {
                    text.textContent = 'Ver menos';
                    icon.classList.remove('bi-chevron-down');
                    icon.classList.add('bi-chevron-up');
                } else {
                    text.textContent = 'Ver todas las p√≠ldoras';
                    icon.classList.remove('bi-chevron-up');
                    icon.classList.add('bi-chevron-down');
                }
            };

            // Toggle expand/collapse for legacy p√≠ldoras table
            window.togglePildorasTableExpandLegacy = function() {
                const hiddenRows = document.querySelectorAll('.pildora-table-row-hidden');
                const text = document.querySelector('.pildora-expand-text-legacy');
                const icon = document.querySelector('.pildora-expand-icon-legacy');
                
                if (!hiddenRows.length) return;
                
                const isCollapsed = hiddenRows[0].style.display !== 'table-row';
                hiddenRows.forEach(row => {
                    row.style.display = isCollapsed ? 'table-row' : 'none';
                });
                
                if (isCollapsed) {
                    text.textContent = 'Ver menos';
                    icon.classList.remove('bi-chevron-down');
                    icon.classList.add('bi-chevron-up');
                } else {
                    text.textContent = 'Ver todas las p√≠ldoras';
                    icon.classList.remove('bi-chevron-up');
                    icon.classList.add('bi-chevron-down');
                }
            };

            // Store functions in the section for easier access
            pildorasSection._navigatePrevious = window.navigatePildorasPrevious;
            pildorasSection._navigateNext = window.navigatePildorasNext;
            pildorasSection._renderTable = renderPildorasTable;
            pildorasSection._modulesData = modulesWithPildoras;

            console.log('Navigation functions assigned');

            // Initial render
            renderPildorasTable();

            console.log('Initial table rendered');
            sections.push(pildorasSection);
        }
    }

    // Schedule Section
    if (info.schedule && hasScheduleData(info.schedule)) {
        const scheduleSection = document.createElement('div');
        scheduleSection.className = 'col-md-12';
        scheduleSection.id = 'horario';
        scheduleSection.innerHTML = `
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title section-title">
                        <i class="bi bi-clock me-2"></i>Horario
                    </h5>
                    ${generateScheduleHTML(info.schedule)}
                </div>
            </div>
        `;
        sections.push(scheduleSection);
    }

    // Team Section
    if (info.team && info.team.length > 0) {
        const teamSection = document.createElement('div');
        teamSection.className = 'col-md-12';
        teamSection.id = 'equipo';
        teamSection.innerHTML = `
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title section-title">
                        <i class="bi bi-people me-2"></i>Equipo
                    </h5>
                    ${generateTeamHTML(info.team)}
                </div>
            </div>
        `;
        sections.push(teamSection);
    }

    // Evaluation Section
    if (info.evaluation && info.evaluation.trim()) {
        const evaluationSection = document.createElement('div');
        evaluationSection.className = 'col-md-12';
        evaluationSection.id = 'evaluacion';
        evaluationSection.innerHTML = `
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title section-title">
                        <i class="bi bi-clipboard-check me-2"></i>Evaluaci√≥n
                    </h5>
                    <div class="mt-3">
                        ${escapeHtml(info.evaluation).replace(/\n/g, '<br>')}
                    </div>
                </div>
            </div>
        `;
        sections.push(evaluationSection);
    }

    // Resources Section
    if (info.resources && info.resources.length > 0) {
        const resourcesSection = document.createElement('div');
        resourcesSection.className = 'col-md-12';
        resourcesSection.id = 'resources';
        resourcesSection.innerHTML = `
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title section-title">
                        <i class="bi bi-tools me-2"></i>Recursos
                    </h5>
                    ${generateResourcesHTML(info.resources)}
                </div>
            </div>
        `;
        sections.push(resourcesSection);
    }

    return sections;
}

// Helper function to check if schedule has data
function hasScheduleData(schedule) {
    if (!schedule) return false;

    const hasOnline = schedule.online && Object.values(schedule.online).some(v => v && v.trim());
    const hasPresential = schedule.presential && Object.values(schedule.presential).some(v => v && v.trim());
    const hasNotes = schedule.notes && schedule.notes.trim();

    return hasOnline || hasPresential || hasNotes;
}

// Generate Schedule HTML
function generateScheduleHTML(schedule) {
    let html = '';

    if (schedule.online && Object.values(schedule.online).some(v => v && v.trim())) {
        html += `
            <div class="mb-3">
                <h6 >Horario Clases Online:</h6>
                <ul>
                    ${schedule.online.entry ? `<li><strong>Inicio:</strong> ${escapeHtml(schedule.online.entry)}</li>` : ''}
                    ${schedule.online.start ? `<li><strong>P√≠ldora:</strong> ${escapeHtml(schedule.online.start)}</li>` : ''}
                    ${schedule.online.break ? `<li><strong>Break:</strong> ${escapeHtml(schedule.online.break)}</li>` : ''}
                    ${schedule.online.lunch ? `<li><strong>Comida:</strong> ${escapeHtml(schedule.online.lunch)}</li>` : ''}
                    ${schedule.online.finish ? `<li><strong>Cierre:</strong> ${escapeHtml(schedule.online.finish)}</li>` : ''}
                </ul>
            </div>
        `;
    }

    if (schedule.presential && Object.values(schedule.presential).some(v => v && v.trim())) {
        html += `
            <div class="mb-3">
                <h6 >Horario Clases Presenciales:</h6>
                <ul>
                    ${schedule.presential.entry ? `<li><strong>Inicio:</strong> ${escapeHtml(schedule.presential.entry)}</li>` : ''}
                    ${schedule.presential.start ? `<li><strong>P√≠ldora:</strong> ${escapeHtml(schedule.presential.start)}</li>` : ''}
                    ${schedule.presential.break ? `<li><strong>Break:</strong> ${escapeHtml(schedule.presential.break)}</li>` : ''}
                    ${schedule.presential.lunch ? `<li><strong>Comida:</strong> ${escapeHtml(schedule.presential.lunch)}</li>` : ''}
                    ${schedule.presential.finish ? `<li><strong>Cierre:</strong> ${escapeHtml(schedule.presential.finish)}</li>` : ''}
                </ul>
            </div>
        `;
    }

    if (schedule.notes && schedule.notes.trim()) {
        html += `<div class="alert alert-info"><strong>Notes:</strong> ${escapeHtml(schedule.notes)}</div>`;
    }

    return html;
}

// Generate Team HTML
function generateTeamHTML(team) {
    let html = '<div class="row">';

    team.forEach(member => {
        html += `
            <div class="col-md-6 mb-3">
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-title">${escapeHtml(member.name || 'Unknown')}</h6>
                        ${member.role ? `<p class="card-text"><span><strong>${escapeHtml(member.role)}</strong></span></p>` : ''}
                        ${member.email ? `<p class="card-text"><i class="bi bi-envelope me-2"></i><a href="mailto:${escapeHtml(member.email)}">${escapeHtml(member.email)}</a></p>` : ''}
                        ${member.linkedin ? `<p class="card-text"><a href="${escapeHtml(member.linkedin)}" target="_blank" class="text-decoration-none"><i class="bi bi-linkedin me-2"></i>LinkedIn Profile</a></p>` : ''}
                    </div>
                </div>
            </div>
        `;
    });

    html += '</div>';
    return html;
}

// Generate Resources HTML
function generateResourcesHTML(resources) {
    let html = '<div class="list-group">';

    resources.forEach(resource => {
        html += `
            <a href="${escapeHtml(resource.url || '#')}" target="_blank" class="list-group-item list-group-item-action">
                <div class="d-flex w-100 justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-1">${escapeHtml(resource.title || 'Untitled Resource')}</h6>
                        ${resource.url ? `<small class="text-muted">${escapeHtml(resource.url)}</small>` : ''}
                    </div>
                    ${resource.category ? `<span class="badge bg-primary">${escapeHtml(resource.category)}</span>` : ''}
                </div>
            </a>
        `;
    });

    html += '</div>';
    return html;
}
